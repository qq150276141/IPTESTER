<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chauvet IP Tester Home</title>
</head>

<style>
  :root {

    --btnRad: 0px;
    --mainColor: rgb(255, 255, 255);
    --textColor: rgb(32, 32, 32);
    --secondColor: white;

  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    background-color: var(--mainColor);
    color: var(--textColor);
    
  }



  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: nowrap;
    min-width: 650px;
    height: 120px;
    color: var(--mainColor);
    background: #000000;
    border-bottom: 1px solid #fff;
    -moz-box-shadow: 0 0 10px #000;
    -webkit-box-shadow: 0 0 10px #000;
    box-shadow: 0 0 10px #000;
    font-family: Cabin;
    font-weight: bold;
    font-style: normal;

  }

  li {
    float: right;
    padding-right: 20px;
    margin: 0 10px 0 0;
    list-style-type: none
  }

  .btn {
    font: bold 18px Arial;
    color: #ffffff;
    text-decoration: none;
  }

  #logo {

    display: block;
    width: 132px;
    height: 85px;
    float: left;
    display: block;
    margin: 20px 60px;

  }

  .appMenue {
    margin: 0;
    margin-top: 20px;
    margin-bottom: 20px;
    /* background: red; */
    display: flex;
    align-items: center;
    justify-content: center;

  }



  .buttonSet {
    margin-left: 20px;
    width: 100px;
    height: 50px;
    border: none;
    border-radius: 5px;
    background-color: black;
    color: var(--secondColor);
    box-shadow: 0px 0px 10px #000000;
    transition: all 0.2s ease-out;

  }

  .buttonSet:hover {
    background-color: #000000;
    color: rgb(255, 255, 255);
    transform: translateY(5px);
    box-shadow: 10px 5px 8px #333;

  }

  .buttonSet:active {
    /* background-color: #09008d; */
    box-shadow: 0 5px #666;
    transform: translateY(5px);
  }


  #t-warp {
    /* background: #333; */
    display: all;
    
  }


  .page {
    
    display: all;

  }

  .row{
    display: flex;
    flex-direction: row;
    
    flex-wrap: nowrap;
    justify-content: center;
}
  

  .column2 {
    /* background: cyan; */
    width: 800px;    
  }

  .column3 {
    /* background: red; */
    position: relative;
    margin-left: 10px;
    float: left;
    width: 400px;
  
  }
  .smallBtn{
    margin-top: 5px;
    width: 60px;
    height: 30px;
    margin-left: 15px;
    border: 0;
    border: none;
    border-radius: 5px;
    background-color: black;
    color: var(--secondColor);
    box-shadow: 0px 0px 5px #000000;
    transition: all 0.2s ease-out;

  }
 
  .smallBtn:hover{
    background: rgb(14, 0, 211);
  }


  .deviceSet {
    text-align: center;
    height: 265px;
    width: 150px;
    /* //background-color: red; */
    margin-left: 35px;
    margin-top: 40px;
    display: inline-block;
    vertical-align: top;
  }


  .deviceBgView {
    width: 100%;
    height: 800px;
    border: 1px solid #333;
    float: left;
    overflow: auto;
    /*background-color: gray;*/
  }
  .connectPageCss{
    text-align: center;
    width: 100%;
    height: 800px;
    border: 1px solid #333;
    float: left;
    overflow: auto;
  }

  .row:after {
    content: "";
    display: table;
    clear: both;
  }

  .selected {
    background: rgba(170, 170, 170, 0.363);

  }

  .liAct {
    color: rgb(14, 0, 211);
  }

  .inputChange{
 position: absolute;
 overflow: hidden;
 right: 0;
 top: 0;
 opacity: 0;
}
</style>

</head>

<body>
  <div class="header">
    <a id="logo"><img src="logo.svg"></a>
    <h1 class="Heading">Chauvet Professional IP Tester 1.0</h1>
    <menu class="menu">
      <li>
        <a class="btn" href='javascript:void(0)' data-name='helpPage' onclick='changeTab(this)'>Help</a>
      </li>
      <li>
        <a class="btn liAct" href='javascript:void(0)' data-name='homePage' onclick='changeTab(this)'>Home</a>
      </li>
    </menu>
  </div>
  <div class="changeTab">
    <div id ="homePage" class="homePage">
      <div class="appMenue">

    <div align="center">
      <button id="btnConnect" class="buttonSet">Connect</button>
    </div>
    <div align="center">
      <button id="btn-setup" class="buttonSet">Testing Page</button>
    </div>
    <br />
    <div align="center">
      <button id="btn-import" class="buttonSet">Open a project</button>
    </div>
    <br />
    <div align="center">
      <button id="btnRefresh" class="buttonSet">Refresh</button>
    </div>
    <br />
    <div align="center">
      <button id="btnDisconnect" class="buttonSet">Disconnect</button>
    </div>
    <br />
    <form action="#">
  </div>

  <div id="t-warp">

    <page class="page">
      <div id="connetPage" class="row"><h1 style="margin-top: 65px;">Please connect IP tester</h2></div>
      <div id="connetPage2" class="row" style="height: 900px; display: none;">

        <div id="column2" class="column2" style="height: 850px;">
          Search : <input style="width:400px;" type="text" id="textLabel" oninput="searchFunction()">
          <br><br>
          <div id="deviceDiv" class="deviceBgView" >
            <div class="deviceSet">
              <div>
                <img src="pics/placehoder.png" height="200px">
              </div>
              <p style="text-align:center;">blank</p>
            </div>

          </div>

        </div>

        <div id="column3" class="column3" style="height: 850px;">
          <div style="width: 100%;height:300px;">
            <br>
            <div
              style="background-color:rgba(211, 211, 211, 0.363);margin: 0 auto; width: 75%;height: 100%;text-align: center; border-radius: 8px;">
              <img id="preview" alt="" name="pic" height="280px" width="250px" src="pics/placehoder.png" />
            </div>
          </div>
          <br>

          <p style="text-align: center;">
            <button id="pickUpBtn" class="smallBtn" type="button" >
              Pick
            <input id="f" type="file" name="f" onchange="change()" class="inputChange">
            </button>
            <button id="saveDataBtn"  type="button"  class="smallBtn">Save</button>
          </p>

          <form>
            <fieldset id='infoform'>
              <legend>Information</legend>
              <table border='0' cellspacing='10'>
                <tr>
                  <td width='150' align='right'>Fixture Name:</td>
                  <td>
                    <input id="deviceName" style="width:150px" type="text" value="" disabled="true" >
                  </td>
                </tr>
                <tr>
                  <td align='right'>Unit:</td>
                  <td>
                    <select id="unitSelect" style="width:150px" type="combo" onchange="getSelectValue(this.value)"
                      disabled="true">
                      <option id="unit" value="psi">psi</option>
                      <option id="unit" value="kPa">kPa</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td id="unitSet" align='right'>Pressure target: limit(0,8.7)</td>
                  <td>
                    <input id="PressureTarget" style="width:150px" type="number" value="0.00" step="0.01"
                      oninput="inputFunction2(this)" οnkeyup="inputFunction(this)" disabled="true">
                  <td class="unitSet5">psi</td>
                  </td>
                </tr>
                <tr>

                  <td id="unitSet2" align='right'>Pressure min: limit(0,8.7)</td>
                  <td>
                    <input id="PressureMin" style="width:150px" value="0.00" type="number" step="0.01"
                      oninput="inputFunction2(this)" οnkeyup="inputFunction(this)" disabled="true">
                  <td class="unitSet5">psi</td>
                  </td>
                </tr>
                <tr>
                  <td align='right'>Hold Time:</td>
                  <td>
                    <input id="PressureHoldTime" style="width:150px" type="text" value="1" disabled="true">
                  <td>sec</td>
                  </td>
                </tr>
                <tr>
                  <td id="unitSet3" align='right'>Vacuum target: limit(-8.7,0)</td>
                  <td>
                    <input id="VacuumTarget" style="width:150px" value="0.00" type="number" step="0.01"
                      oninput="inputFunction3(this)" οnkeyup="inputFunction(this)" disabled="true">
                  <td class="unitSet5">psi</td>
                  </td>
                </tr>
                <tr>
                  <td id="unitSet4" align='right'>Vacuum min: limit(-8.7,0)</td>
                  <td>
                    <input id="VacuumMin" style="width:150px" value="0.00" type="number" step="0.01"
                      oninput="inputFunction3(this)" οnkeyup="inputFunction(this)" disabled="true">
                  <td class="unitSet5">psi</td>
                  </td>
                </tr>
                <tr>
                  <td align='right'>Hold Time:</td>
                  <td>
                    <input id="VacuumHoldTime" style="width:150px" type="text" value="1" disabled="true">
                  <td>sec</td>
                  </td>
                </tr>

              </table>

              <button id="edit" type="button" class="smallBtn"
                style="width: 40px;height: 30px;position: absolute;left: 20px;top: 585px; margin: 0;">Edit</button>

              <div style="text-align: center;">
                <button id="btnUpload" type="button" class="smallBtn">Upload</button>
                <button id="btnDelete" type="button" class="smallBtn">Delete</button>
                <button id="cancelBtn" type="button" class="smallBtn">Cancel</button>
              </div>
              <br>
            </fieldset>
          </form>

        </div>
      </div>

      <div style="display:none"> <input id="import" type="file" onchange="fileImport();" /> </div>
      <br>
      <br>
      <br>

      <div id="secPage" style="display:none; "    >
        <div id="myChart" style="width:1200px;height:600px;background-size:100% 100%;left:50%;transform:translateX(-50%)" ></div>
        <br>
        <div style="min-width:1200px;text-align: center;">
        <div id="testLabel" style="margin-left: 800px;font-size: 30px;color: red;" ></div>
        </div>
        <div style="min-width:600px;text-align:center;">

          Current Pressure:<label id="currentPressure"></label>
          <br>
          <br>
          Test Time:<label id="holdTime"></label>
          <br>
          <br>
        </div>

        <div style="min-width:600px;text-align: center;">
          <button id="btnBack"     style="width: 80px;height: 30px;"                    class="smallBtn">Main</button>
          <button id="btnPressure" style="width: 80px;height: 30px;margin-left: 20px;"  class="smallBtn">Pressure</button>
          <button id="btnVacuum"   style="width: 80px;height: 30px;margin-left: 20px;"  class="smallBtn">Vacuum</button>
          <button id="btnAuto"     style="width: 80px;height: 30px;margin-left: 20px;"  class="smallBtn">Auto</button>
          <button id="btnEnd"      style="width: 80px;height: 30px;margin-left: 20px;"  class="smallBtn">End</button>
          <button id="btnSave"     style="width: 80px;height: 30px;margin-left: 20px;"  class="smallBtn">save</button>
        </div>
          <br>
          <br>
          <br>
      </div>

    </page>
    </div>
    
    <div id ="helpPage" class="helpPage" style="display: none;">
      <!-- help page content-->
    </div>
  </div>
  
    
    <script type="text/javascript" src="jquery-3.6.0.slim.min.js"></script>
    <script src="echarts4.8.0.min.js"></script>
    <script src="FileSaver.min.js" type="text/javascript"></script>
    <script src="exceljs.min.js" type="text/javascript"></script>
    <script src="fixtures.js" type="text/javascript"></script>
    <script type="text/javascript">

      var markUnit;

      var double;

      function getSelectValue(val) {

        secModel.Unit = val;
        console.log(secModel.Unit);

        if (val == "kPa") {
          console.log("ptkpa =" + secModel.PressureTargetkpa.toFixed(1));

          if (secModel.PressureTargetkpa.toFixed(1) == ($("#PressureTarget").val() * 6.895).toFixed(1)) {

            $("#PressureTarget").val(secModel.PressureTargetkpa.toFixed(1));
          } else {
            $("#PressureTarget").val(($("#PressureTarget").val() * 6.895).toFixed(1));
          }

          if (secModel.PressureMinkpa.toFixed(1) == ($("#PressureMin").val() * 6.895).toFixed(1)) {

            $("#PressureMin").val(secModel.PressureMinkpa.toFixed(1));
          } else {
            $("#PressureMin").val(($("#PressureMin").val() * 6.895).toFixed(1));
          }

          if (secModel.VacuumTargetkpa.toFixed(1) == ($("#VacuumTarget").val() * 6.895).toFixed(1)) {

            $("#VacuumTarget").val(secModel.VacuumTargetkpa.toFixed(1));
          } else {
            $("#VacuumTarget").val(($("#VacuumTarget").val() * 6.895).toFixed(1));
          }

          if (secModel.VacuumMinkpa.toFixed(1) == ($("#VacuumMin").val() * 6.895).toFixed(1)) {

            $("#VacuumMin").val(secModel.VacuumMinkpa.toFixed(1));
          } else {
            $("#VacuumMin").val(($("#VacuumMin").val() * 6.895).toFixed(1));
          }


          $("#unitSet").text("Pressure target: limit(0,60)");
          $("#unitSet2").text("Pressure min: limit(0,60)");
          $("#unitSet3").text("Vacuum target: limit(0,-60)");
          $("#unitSet4").text("Vacuum min: limit(0,-60)");
          $(".unitSet5").text("kPa");
        }
        if (val == "psi") {
          if (secModel.PressureTarget.toFixed(2) == ($("#PressureTarget").val() / 6.895).toFixed(2)) {

            $("#PressureTarget").val(secModel.PressureTarget.toFixed(2));
          } else {
            $("#PressureTarget").val(($("#PressureTarget").val() / 6.895).toFixed(2));
          }

          if (secModel.PressureMin.toFixed(2) == ($("#PressureMin").val() / 6.895).toFixed(2)) {

            $("#PressureMin").val(secModel.PressureMin.toFixed(2));
          } else {
            $("#PressureMin").val(($("#PressureMin").val() / 6.895).toFixed(2));
          }

          if (secModel.VacuumTarget.toFixed(2) == ($("#VacuumTarget").val() / 6.895).toFixed(2)) {

            $("#VacuumTarget").val(secModel.VacuumTarget.toFixed(2));
          } else {
            $("#VacuumTarget").val(($("#VacuumTarget").val() / 6.895).toFixed(2));
          }



          if (secModel.VacuumMin.toFixed(2) == ($("#VacuumMin").val() / 6.895).toFixed(2)) {

            $("#VacuumMin").val(secModel.VacuumMin.toFixed(2));
          } else {
            $("#VacuumMin").val(($("#VacuumMin").val() / 6.895).toFixed(2));
          }

          $("#unitSet").text("Pressure target: limit(0,8.7)");
          $("#unitSet2").text("Pressure min: limit(0,8.7)");
          $("#unitSet3").text("Vacuum target: limit(0,-8.7)");
          $("#unitSet4").text("Vacuum min: limit(0,-8.7)");
          $(".unitSet5").text("psi");

        }
      }

      var deviceArr = [
        {
          deviceName: "New",
          devicePic: "pics/New.png",
          Unit: "psi",
          PressureTarget: "0.00",
          PressureMin: "0.00",
          PressureHoldTime: 1,
          VacuumTarget: "0.00",
          VacuumMin: "0.00",
          VacuumHoldTime: 1,
          deviceFrame: [],
          saveTime: ""
        }
      ];

      var receiceArr = [];
      var finalArray = [];
      var searchArray = [];
      var testResult = "";
      var testWay;
      var subtextName = "                          ";
      var disabled = true;
      loadData(receiceArr);

      $('#edit').click(function () {
        $(this).toggleClass('selected');
        if (disabled == false) {

          disabled = true;
        } else {
          disabled = false;
        }
        console.log("isEditing = " + disabled);

        $("#deviceName").attr("disabled", disabled);
        $("#unitSelect").attr("disabled", disabled);
        $("#PressureTarget").attr("disabled", disabled);
        $("#PressureMin").attr("disabled", disabled);
        $("#VacuumTarget").attr("disabled", disabled);
        $("#VacuumMin").attr("disabled", disabled);
        $("#PressureHoldTime").attr("disabled", disabled);

        $("#unitSet").attr("disabled", disabled);
        $("#unitSet2").attr("disabled", disabled);
        $("#unitSet3").attr("disabled", disabled);
        $("#unitSet4").attr("disabled", disabled);
        $(".unitSet5").attr("disabled", disabled);
        $("#VacuumHoldTime").attr("disabled", disabled);
      });

      var secModel;
      $(".deviceBgView").on("click", ".deviceSet", function () {


        // $(this).html("aaasdsd");
        $(".deviceBgView .deviceSet").removeClass("selected");
        $(this).addClass("selected");

        var retArr = [];
        if (searchArray.length > 0) {
          retArr = searchArray;
        } else {
          retArr = finalArray;
        }

        secModel = retArr[$(this).index()];
        // var devicePic = "pics/"+secModel.deviceName+".png";
        $("#preview").attr('src', secModel.devicePic);
        $("#preview").attr("onerror", "this.src='pics/placehoder.png'");
        cancelImage();
        // alert($("#deviceName").val());
        console.log("secModelname = " + secModel.deviceName);
        console.log("PressureTarget =" + secModel.PressureTarget);
        console.log("PressureTargetkpa =" + secModel.PressureTargetkpa);
        console.log("vaccumTarget =" + secModel.VacuumTarget);
        console.log("vaccumTarget =" + secModel.VacuumTargetkpa);

        $("#deviceName").val(secModel.deviceName);
        $("#PressureTarget").val(secModel.PressureTarget);
        $("#PressureMin").val(secModel.PressureMin);
        $("#PressureHoldTime").val(secModel.PressureHoldTime);
        $("#VacuumTarget").val(secModel.VacuumTarget);
        $("#VacuumMin").val(secModel.VacuumMin);
        $("#VacuumHoldTime").val(secModel.VacuumHoldTime);

        secModel.Unit = $("#unitSelect").val();
        if ($("#unitSelect").val() == "kPa") {
          getSelectValue("kPa");
        }

        if (reader) {

          var retNameArr = [];
          for (var i = 0; i < receiceArr.length; i++) {

            retNameArr.push(receiceArr[i].deviceName);
            // console.log(receiceArr[i].deviceName);
          }
          for (var i = 0; i < deviceArr.length; i++) {

            retNameArr.push(deviceArr[i].deviceName);
          }


          if (retNameArr.indexOf(secModel.deviceName) == -1) {
            addLocalDevice(secModel);
          }
        }

      });


      $("#cancelBtn").on("click", function () {
        secModel = null;
        $(".deviceBgView .deviceSet").removeClass("selected");

        $("#preview").attr('src', "pics/placehoder.png");
        $("#deviceName").val("");
        $("#PressureTarget").val("0.00");
        $("#PressureMin").val("0.00");
        $("#PressureHoldTime").val("1");
        $("#VacuumTarget").val("0.00");
        $("#VacuumMin").val("0.00");
        $("#VacuumHoldTime").val("1");

      });

      $("#btn-setup").on("click", function () {
        // console.log(secModel);
        if (secModel) {

          $(".row").hide();
          $("#secPage").show();
          secondPageCreat(secModel);
        }

      });

      $("#btn-import").on("click", function () {
        if (reader) {
          $("#import").click();

        } else {
          alert("Please connect port");
        }

      });

      $("#btnBack").on("click", function () {
        $("#btnEnd").click();
        document.getElementById('import').value = null;
        receivedframe = [];
        subtextName = "                          ";
        $(".row").show();
        $("#secPage").hide();
      });

      function cancelImage() {

        file = document.getElementById("f");
        file.value = "";
      }

      function fileImport() {

        var selectedFile = document.getElementById('import').files[0];
        var name = selectedFile.name;
        var size = selectedFile.size;
        console.log("name:" + name + " size:" + size);

        var reader = new FileReader();
        reader.readAsText(selectedFile);
        reader.onload = function () {

          secModel = JSON.parse(this.result);
          if (secModel) {
            $(".row").hide();
            $("#secPage").show();
            // subtextName = "                          "+secModel.saveTime;
            receivedframe = secModel.deviceFrame;
            secondPageCreat(secModel);
          }
        }
      }


      function change() {
        var pic = document.getElementById("preview"),
          file = document.getElementById("f");

        var ext = file.value.substring(file.value.lastIndexOf(".") + 1).toLowerCase();
        // console.log("file = "+ext);
        var isIE = navigator.userAgent.match(/MSIE/) != null,
          isIE6 = navigator.userAgent.match(/MSIE 6.0/) != null;

        if (isIE) {
          file.select();
          var reallocalpath = document.selection.createRange().text;

          if (isIE6) {
            pic.src = reallocalpath;
          } else {
            pic.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='image',src=\"" + reallocalpath + "\")";

            pic.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==';
          }
        } else {
          html5Reader(file);
        }
      }

      function html5Reader(file) {
        var file = file.files[0];

        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function (e) {
          var pic = document.getElementById("preview");

          pic.src = this.result;

        }
      }


      var isWorking = false;
      var chartDom = document.getElementById('myChart');
      var myChart = echarts.init(chartDom, 'light');
      var option;
      var timeArray = [];
      for (var i = 0; i < 101; i++) {
        timeArray.push(i);
      }

      function secondPageCreat(secModel) {

        double = (secModel.Unit == "psi" ? 1 : 6.895);
        option = {
          backgroundColor: '#FFFFFF',
          title: {
            top: 20,
            subtext: subtextName,
            subtextStyle: {
              textAlign: 'left',
              color: 'black',
              fontSize: 18
            }
          },
          tooltip: {
            trigger: 'axis'
          },
          legend: {
            // data: ['device'],
            textStyle: {
              fontSize: '22'
            }
          },
          toolbox: {
            show: true,
            feature: {
              // saveAsImage: {}
            }
          },
          xAxis: {
            name: 'time(sec)',
            nameLocation: 'center',
            nameGap: '30',
            nameTextStyle: {
              fontSize: '18',
            },
            boundaryGap: false,
            axisLine: {
              onZero: false,
              lineStyle: {
                color: 'black'
              },
            },
            type: 'value',
            max: '300',
            min: '0',
            splitNumber: 10,
            data: timeArray,
            splitLine: {
              show: true
            }
          },
          yAxis: {
            name: 'Pressure(' + secModel.Unit + ')',
            nameLocation: 'center',
            nameGap: '30',
            nameTextStyle: {
              fontSize: '18',
            },
            type: 'value',
            max: parseInt(secModel.PressureTarget) * 1.5 * double,
            min: parseInt(secModel.VacuumTarget) * 1.5 * double,
            splitNumber: '8',
            splitLine: {
              show: true
            }
          },


          series: [
            {
              name: secModel.deviceName,
              type: 'line',
              data: receivedframe,
              symbol: 'circle',
              symbolSize: '8',
              itemStyle: {
                color: '#3398DB'
              },
              lineStyle: {
                color: '#3398DB'
              },
              markLine: {
                symbol: "none",
                animation: false,
                data: [
                  {
                    name: 'Pressure target',
                    yAxis: $("#PressureTarget").val(),
                    lineStyle: {
                      type: "solid",
                      color: "gray",
                      width: '2'
                    }
                  },
                  {
                    name: 'Pressure min',
                    yAxis: $("#PressureMin").val(),
                    lineStyle: {
                      type: "solid",
                      color: "gray",
                      width: '2'
                    }
                  },
                  {
                    name: 'VacuumTarget',
                    yAxis: $("#VacuumTarget").val(),
                    lineStyle: {
                      type: "solid",
                      color: "gray",
                      width: '2'
                    }
                  },
                  {
                    name: 'VacuumMin',
                    yAxis: $("#VacuumMin").val(),
                    lineStyle: {
                      type: "solid",
                      color: "gray",
                      width: '2'
                    }
                  }
                ]
              }
            }
          ]
        };

        option && myChart.setOption(option);

      }


      function loadData(lightArray) {


        finalArray = [];

        for (var i = 0; i < lightArray.length; i++) {
          finalArray.push(lightArray[i]);
        }

        var retNameArr = [];
        for (var i = 0; i < receiceArr.length; i++) {

          retNameArr.push(receiceArr[i].deviceName);
        }
        for (var i = 0; i < localDeviceArr.length; i++) {
          if (retNameArr.indexOf(localDeviceArr[i].deviceName) == -1) {
            finalArray.push(localDeviceArr[i]);
          }
        }

        for (var i = 0; i < deviceArr.length; i++) {
          finalArray.push(deviceArr[i]);
        }


        var html = '';
        for (var i = 0; i < finalArray.length; i++) {
          html += setDiv(finalArray[i]);
        }
        var deviceDiv = document.getElementById('deviceDiv');

        deviceDiv.innerHTML = html;

      }

      function setDiv(dic) {

        var scrPath = "";
        scrPath = "pics/" + dic.deviceName + ".png?Guid=" + new Date(+new Date() + 8 * 3600 * 1000).toJSON().substr(0, 19).replace("T", " ");
        scrPath = scrPath.replace(/\s/g, encodeURIComponent(' '));
        dic.devicePic = scrPath;

        var shortName = dic.deviceName;
        if (dic.deviceName.length > 14) {
          if (dic.deviceName.length > 14) {
            shortName = dic.deviceName.slice(0, 14) + " " + dic.deviceName.slice(14);
          }
        }

        var div = '<div class="deviceSet"><div><img class="imgPic" src=' + scrPath + ' onerror="imgerrorfun();" height="200px"></div><p style="text-align:center;">'
          + shortName
          + '</p><br/></div>';

        return div;
      }
      function imgerrorfun() {
        var img = event.srcElement;
        img.src = "pics/placehoder.png";
        img.onerror = null;
      }


      var writeInt;

      /*** find the chart and list tag above***/

      let keepReading = true;
      let reader;
      let writer;
      // all data parsed are stored in a list ordered by received time of the data frame.
      let receivedframe = [];
      let port;
      let dataArray = new Uint8Array(80);
      let checkLength = [];
      let lightArray = [];

      document
        .getElementById("btnConnect")
        .addEventListener("click", async () => {


          if (reader) {

            alert("Port is connected");


          } else {

            port = await navigator.serial.requestPort();

            await port.open({ baudRate: 115200, dataBits: 8, stopBits: 1, parity: "none" });

            keepReading = true;

            reader = port.readable.getReader();
            writer = port.writable.getWriter();

            // dataArray[0] = 0x00;
            dataArray[1] = 128;
            dataArray[2] = 1;
            dataArray[3] = 255;
            dataArray[4] = 255;
            dataArray[5] = 1;
            dataArray[67] = 2;
            dataArray[68] = 0;

            receiceArr = [];
            sendDataWithArray(dataArray, 100);
            
            var retPage = document.getElementById("connetPage").setAttribute('style', 'display:none');
            var retPage = document.getElementById("connetPage2").setAttribute('style', 'display:all');
            var openColumn2 = document.getElementById("column2").setAttribute('style', 'display:all');
            var openColumn3 = document.getElementById("column3").setAttribute('style', 'display:all');
            


          }


        });


      document
        .getElementById("btnDisconnect")
        .addEventListener("click", async () => {
          {
            if (reader) {

              setTimeout('location.reload()', 0);
            } else {

              alert("Please connect port");
            }
          }
        });

      /*****************************************/

      async function sendDataWithArray(dataArray, timeSet) {
        // body...

        // set how to write to device intervally
        setTimeout(async () => {
          // console.log(dataArray);
          await writer.write(dataArray);

        }, timeSet); // send a frame every 100ms

        while (port.readable && keepReading) {

          try {
            while (true) {
              const { value, done } = await reader.read();
              if (done) {
                // reader.cancel() has been called.
                break;
              }
              // value is a Uint8Array.
              /*** TODO: deal with the data value ***/
              if (value.length == 71) {

                dealWithData(value);

              } else {

                for (var i = 0; i < value.length; i++) {
                  checkLength.push(value[i]);
                }

                if (checkLength.length == 71) {

                  let arr = new Uint8Array(71);
                  for (var j = 0; j < 71; j++) {
                    arr[j] = checkLength[j];
                  }

                  dealWithData(arr);
                  checkLength = [];
                }
              }

            }
          } catch (error) {
            // Handle error...
          } finally {
            // Allow the serial port to be closed later.
            console.log(port.readable, keepReading);
          }
        }

      }

      /*****************************************/


      /*** btnAuto listener below ***/
      function setDataArray(number, action) {
        //
        var retValue;
        if (number.length > 0) {
          retValue = number;
        } else {
          retValue = 1;
        }
        for (var i = 0; i < dataArray.length; i++) {
          dataArray[i] = 0;
        }
        var num = 0;
        dataArray[1] = 130;//0x82
        dataArray[2] = number || 1;
        dataArray[3] = action;

        dataArray[57] = 13;


        for (var i = 2; i < 67; i++) {
          num += dataArray[i];
        }

        dataArray[68] = num & 0xff;
        dataArray[67] = (num >> 8) & 0xff;
        // console.log(dataArray[2]);

      }

      document
        .getElementById("btnPressure")
        .addEventListener("click", async () => {

          if (isWorking == false) {
            isWorking = true;
            testWay = 1;
            testResult = "";
            subtextName = "                          Pressure Test";
            var testDiv = document.getElementById('testLabel');
            testDiv.innerHTML = "";

            receivedframe = [];
            secondPageCreat(secModel);

            setDataArray(secModel.num, 1);
            writeInt = setInterval(async () => {
              sendDataWithArray(dataArray, 100);
            }, 500); // send a frame every 1000ms
          } else {
            console.log("please hold on ,it is working");
          }
        });

      document
        .getElementById("btnVacuum")
        .addEventListener("click", async () => {

          if (isWorking == false) {
            isWorking = true;
            testWay = 2;
            testResult = "";
            subtextName = "                          Vacuum Test";
            var testDiv = document.getElementById('testLabel');
            testDiv.innerHTML = "";
            receivedframe = [];
            secondPageCreat(secModel);
            setDataArray(secModel.num, 2);
            writeInt = setInterval(async () => {
              sendDataWithArray(dataArray, 100);
            }, 500); // send a frame every 1000ms

          } else {
            console.log("please hold on ,it is working");
          }
        });

      document
        .getElementById("btnEnd")
        .addEventListener("click", async () => {
          if (isWorking == true) {
            isWorking = false;
            // subtextName = "";
            clearInterval(writeInt);
            setDataArray(secModel.num, 3);
            sendDataWithArray(dataArray);

          } else {
            console.log("none information")
          }

        });

      document
        .getElementById("btnAuto")
        .addEventListener("click", async () => {

          if (isWorking == false) {
            isWorking = true;
            testWay = 2;
            testResult = "";
            var testDiv = document.getElementById('testLabel');
            testDiv.innerHTML = "";
            receivedframe = [];
            subtextName = "                          Auto Test";
            secondPageCreat(secModel);
            setDataArray(secModel.num, 4);
            writeInt = setInterval(async () => {
              sendDataWithArray(dataArray, 100);
            }, 500); // send a frame every 1000ms
          } else {
            console.log("please hold on ,it is working");
          }
        });

      document
        .getElementById("btnRefresh")
        .addEventListener("click", async () => {

          if (reader) {

            for (var i = 0; i < dataArray.length; i++) {
              dataArray[i] = 0;
            }
            dataArray[1] = 128;
            dataArray[2] = 1;
            dataArray[3] = 255;
            dataArray[4] = 255;
            dataArray[5] = 1;
            dataArray[67] = 2;
            dataArray[68] = 0;

            receiceArr = [];
            sendDataWithArray(dataArray, 100);


          } else {
            alert("Please connect port");
          }

        });


      document
        .getElementById("btnDelete")
        .addEventListener("click", async () => {
          var retNameArr = ($("#deviceName").val().split(''));
          var retPressureTArr = parseInt(Math.round($("#PressureTarget").val() * 100)).toString().split('');
          var retPressureMArr = parseInt(Math.round($("#PressureMin").val() * 100)).toString().split('');
          var retPHoldTimeArr = parseInt($("#PressureHoldTime").val()).toString().split('');
          var retVacuumTArr = parseInt(Math.round(Math.abs($("#VacuumTarget").val()) * 100)).toString().split('');
          var retVacuumMArr = parseInt(Math.round(Math.abs($("#VacuumMin").val()) * 100)).toString().split('');
          var retVHoldTimeArr = parseInt($("#VacuumHoldTime").val()).toString().split('');

          for (var i = 0; i < dataArray.length; i++) {
            dataArray[i] = 0;
          }

          console.log(secModel.num);
          var num = 0;
          dataArray[1] = 131; //0x83
          dataArray[2] = 47;
          dataArray[3] = secModel.num;

          dataArray[4] = 47;
          for (var i = 0; i < retNameArr.length; i++) {
            dataArray[i + 5] = retNameArr[i].charCodeAt();
          }
          dataArray[35] = 47;  // "/"

          for (var i = 0; i < retPressureTArr.length; i++) {
            dataArray[i + 36] = retPressureTArr[i].charCodeAt();

          }
          dataArray[39] = 47;
          for (var i = 0; i < retPressureMArr.length; i++) {
            dataArray[i + 40] = retPressureMArr[i].charCodeAt();
          }
          dataArray[43] = 47;
          for (var i = 0; i < retPHoldTimeArr.length; i++) {
            dataArray[i + 44] = retPHoldTimeArr[i].charCodeAt();
          }

          dataArray[46] = 47;
          for (var i = 0; i < retVacuumTArr.length; i++) {
            dataArray[i + 47] = retVacuumTArr[i].charCodeAt();
          }

          dataArray[50] = 47;
          for (var i = 0; i < retVacuumMArr.length; i++) {
            dataArray[i + 51] = retVacuumMArr[i].charCodeAt();
          }
          dataArray[54] = 47;
          for (var i = 0; i < retVHoldTimeArr.length; i++) {
            dataArray[i + 55] = retVHoldTimeArr[i].charCodeAt();
          }
          dataArray[57] = 13;


          for (var i = 2; i < 67; i++) {
            num += dataArray[i];
          }
          console.log("num = " + num);
          dataArray[68] = num & 0xff;
          dataArray[67] = (num >> 8) & 0xff;
          sendDataWithArray(dataArray);

          setTimeout('$("#btnRefresh").click()', 500);

          if (markUnit.length) {
            getSelectValue(markUnit);
          }
        });

      document
        .getElementById("btnUpload")
        .addEventListener("click", async () => {
          var retNameArr;
          var retPressureTArr;
          var retPressureMArr;
          var retPHoldTimeArr;
          var retVacuumTArr;
          var retVacuumMArr;
          var retVHoldTimeArr;

          markUnit = $("#unitSelect").val();

          retNameArr = ($("#deviceName").val().split(''));
          retPHoldTimeArr = parseInt($("#PressureHoldTime").val()).toString().split('');
          retVHoldTimeArr = parseInt($("#VacuumHoldTime").val()).toString().split('');

          if ($("#unitSelect").val() == "psi") {

            retPressureTArr = parseInt(Math.round($("#PressureTarget").val() * 100)).toString().split('');
            retPressureMArr = parseInt(Math.round($("#PressureMin").val() * 100)).toString().split('');
            retVacuumTArr = parseInt(Math.round(Math.abs($("#VacuumTarget").val()) * 100)).toString().split('');
            retVacuumMArr = parseInt(Math.round(Math.abs($("#VacuumMin").val()) * 100)).toString().split('');

          }
          if ($("#unitSelect").val() == "kPa") {

            retPressureTArr = ($("#PressureTarget").val() * 100 / 6.895).toFixed(0).toString().split('');
            retPressureMArr = ($("#PressureMin").val() * 100 / 6.895).toFixed(0).toString().split('');
            retVacuumTArr = (Math.abs($("#VacuumTarget").val() * 100 / 6.895).toFixed(0)).toString().split('');
            retVacuumMArr = (Math.abs($("#VacuumMin").val() * 100 / 6.895).toFixed(0)).toString().split('');

          }
          // console.log("PTARR = "+retPressureTArr);
          // console.log("PMARR = "+retPressureMArr);
          // console.log("VTARR = "+retVacuumTArr);
          // console.log("VMARR = "+retVacuumMArr);

          for (var i = 0; i < dataArray.length; i++) {
            dataArray[i] = 0;
          }

          var num = 0;
          dataArray[1] = 129; //0x81
          dataArray[2] = 47;
          dataArray[3] = 1 + 48;

          dataArray[4] = 47;
          for (var i = 0; i < retNameArr.length; i++) {
            dataArray[i + 5] = retNameArr[i].charCodeAt();
          }
          dataArray[35] = 47;  // "/"
          for (var i = 0; i < retPressureTArr.length; i++) {
            dataArray[i + 36] = retPressureTArr[i].charCodeAt();

          }
          dataArray[39] = 47;
          for (var i = 0; i < retPressureMArr.length; i++) {
            dataArray[i + 40] = retPressureMArr[i].charCodeAt();
          }
          dataArray[43] = 47;
          for (var i = 0; i < retPHoldTimeArr.length; i++) {
            dataArray[i + 44] = retPHoldTimeArr[i].charCodeAt();
          }

          dataArray[46] = 47;
          for (var i = 0; i < retVacuumTArr.length; i++) {
            dataArray[i + 47] = retVacuumTArr[i].charCodeAt();
          }

          dataArray[50] = 47;
          for (var i = 0; i < retVacuumMArr.length; i++) {
            dataArray[i + 51] = retVacuumMArr[i].charCodeAt();
          }
          dataArray[54] = 47;
          for (var i = 0; i < retVHoldTimeArr.length; i++) {
            dataArray[i + 55] = retVHoldTimeArr[i].charCodeAt();
          }
          dataArray[57] = 13;


          for (var i = 2; i < 67; i++) {
            num += dataArray[i];
          }
          console.log("num = " + num);
          dataArray[68] = num & 0xff;
          dataArray[67] = (num >> 8) & 0xff;
          sendDataWithArray(dataArray);

          setTimeout('$("#btnRefresh").click()', 500);
        });


      document
        .getElementById("saveDataBtn")
        .addEventListener("click", async () => {

          var pic = document.getElementById("preview");


          if (!secModel) {
            alert("Please select a fixture or create a new fixture");
          }

          downloadIamge(pic, secModel.deviceName);

        });
        document
        .getElementById("pickUpBtn")
        .addEventListener("click", async () => {

          $("#f").click();
        });
        

      function downloadIamge(selector, name) {
        var image = new Image()

        image.setAttribute('crossOrigin', 'anonymous')

        image.onload = function () {

          var canvas = document.createElement('canvas')
          canvas.width = image.width
          canvas.height = image.height

          var context = canvas.getContext('2d')
          context.drawImage(image, 0, 0, image.width, image.height)
          var url = canvas.toDataURL('image/png')

          var a = document.createElement('a')

          var event = new MouseEvent('click')

          a.download = name || 'no name pic'

          a.href = url

          a.dispatchEvent(event)

        }
        image.onerror = function (e) {
          alert("Please select a new image");
        }


        image.src = selector.src
      }

      /*** btnAuto listener above ***/

      /*** function dealWithData below ***/
      function dealWithData(value) {

        function checkSum(buf) {
          let checksum = 0;
          buf.forEach((val, idx) => {
            if (idx > 2 && idx < 69) {
              checksum += val;
            }
          });

          if (((buf[70] << 8) + buf[69]) == checksum) {
            return 1;
          }
        }

        if (checkSum(value)) {

          if (value[2] == 128) {
            let num = value[4];
            let arr = [];
            for (var i = 0; i < 30; i++) {
              if (value[i + 6] == 0) { break; }
              arr.push(String.fromCharCode(value[i + 6]))

            }
            let deviceName = arr.join("");

            let PressureTarget = ((value[37] << 8) | value[38]) / 100;
            let PressureMin = ((value[43] << 8) | value[44]) / 100;
            let PressureHoldTime = (value[40] << 8) | value[41];

            let VacuumTarget = ((value[46] << 8) | value[47]) / 100 * (-1);
            let VacuumMin = ((value[52] << 8) | value[53]) / 100 * (-1);
            let VacuumHoldTime = (value[49] << 8) | value[50];

            let PressureTargetkpa = PressureTarget * 6.895.toFixed(2);
            let PressureMinkpa = PressureMin * 6.895.toFixed(2);

            let VacuumTargetkpa = ((value[46] << 8) | value[47]) / 100 * 6.895.toFixed(2) * (-1);
            let VacuumMinkpa = ((value[52] << 8) | value[53]) / 100 * 6.895.toFixed(2) * (-1);
            let frame = {
              num,
              deviceName,
              devicePic: "pics/placehoder.png",
              PressureTarget,
              PressureMin,
              PressureHoldTime,
              VacuumTarget,
              VacuumMin,
              VacuumHoldTime,
              PressureTargetkpa,
              PressureMinkpa,
              VacuumTargetkpa,
              VacuumMinkpa
            };
            // console.log('position='+ num);
            // console.log('deviceName='+ deviceName);
            // console.log('PressureTarget='+ PressureTarget);
            // console.log('PressureTargetkpa='+ PressureTargetkpa);
            // console.log('PressureMin='+ PressureMin);
            // console.log('PressureHoldTime='+ PressureHoldTime);
            // console.log('VacuumTarget='+ VacuumTarget);
            // console.log('VacuumMin='+ VacuumMin);
            // console.log('VacuumHoldTime='+ VacuumHoldTime);
            receiceArr.push(frame);

            loadData(receiceArr);
          }

          /* --------------------------------------------------------------- */

          if (value[2] == 130) {
            var currentTime = value[5];
            var currentValue = (((value[7] << 8) | value[8]) / 100 * double).toFixed(2);
            if (value[6] == 1) {
              currentValue = -1 * currentValue;
            }
            let testFrame = [
              currentTime,
              currentValue
            ];
            // console.log('currentTime='+ currentTime);
            // console.log('currentValue='+ currentValue);

            var curretnP = document.getElementById('currentPressure');
            curretnP.innerHTML = currentValue;
            var holdT = document.getElementById('holdTime');
            holdT.innerHTML = currentTime;

            receivedframe.push(testFrame);
            // console.log(receivedframe);
            secModel.saveTime = "";
            // // update the chart
            myChart.setOption({
              series: [{
                data: receivedframe
              }]
            });
            // option && myChart.setOption(option);
            secondPageCreat(secModel);
            var testDiv = document.getElementById('testLabel');
            if (testWay == 1) {

              if (currentValue >= 0) {


                if (value[9] == 1) {

                  $("#btnEnd").click();
                  testResult = "Pass";
                  testDiv.innerHTML = testResult;
                  // console.log(testResult);
                }
                if (value[9] == 2) {

                  $("#btnEnd").click();
                  testResult = "Fail";
                  testDiv.innerHTML = testResult;
                  // console.log(testResult);
                }

              }
            }

            if (testWay == 2) {

              if (value[9] == 2) {

                $("#btnEnd").click();
                testResult = "Fail";
                testDiv.innerHTML = testResult;
                // console.log(testResult);
              }
              if (currentValue < 0) {

                if (value[9] == 1) {

                  $("#btnEnd").click();
                  testResult = "Pass";
                  testDiv.innerHTML = testResult;
                  // console.log(testResult);
                }

              }

            }

          }

        }
      }
      /*** function dealWithData above ***/


      /*** saveBtn listener below ***/
      var workbook = new ExcelJS.Workbook();

      var ws = workbook.addWorksheet('My Sheet');

      var btn = document.getElementById("btnSave");

      btn.addEventListener("click", async () => {
        var nowTime = new Date(+new Date() + 8 * 3600 * 1000).toJSON().substr(0, 19).replace("T", " ");

        try {

          const myBase64Image = myChart.getConnectedDataURL({

            backgroundColor: "rgba(0,0,0,0)",
            type: "png"
          });

          const imageId2 = workbook.addImage({
            base64: myBase64Image,
            extension: 'png',

          });

          ws.addImage(imageId2, 'C5:H17');
          ws.properties.defaultRowHeight = 25;
          ws.columns = [
            { header: 'FixtureName', key: 'Fixture Name', width: 20, style: { alignment: { vertical: 'middle' } } },
            { header: '', key: 'FixtureName', width: 20, style: { alignment: { vertical: 'middle', horizontal: 'center' }, font: { size: 16, bold: true } } },
            { header: 'serialNumber', key: 'serial Number', width: 30, style: { alignment: { vertical: 'middle', horizontal: 'center' } } },
            { header: 'TestResult', key: 'Test Result', width: 30, style: { alignment: { vertical: 'middle', horizontal: 'center' } } },
          ];




          ws.getCell('A1').alignment = { vertical: 'middle', horizontal: 'center' };
          ws.getCell('A2').alignment = { vertical: 'middle', horizontal: 'center' };
          ws.getCell('A2').font = { size: 16, bold: true };
          ws.getCell('C2').font = { size: 16, bold: true };
          ws.getCell('D2').font = { size: 16, bold: true };

          ws.getCell('A2').value = secModel.deviceName;
          ws.getCell('C2').value = 'Device SN#';
          ws.getCell('D2').value = testResult;
          ws.getCell('A3').value = 'Date:';

          //当前时间 new Date( +new Date() + 8 * 3600 * 1000 ).toJSON().substr(0,19).replace("T"," ")
          ws.getCell('B3').value = nowTime;
          ws.getCell('A5').value = 'Parameters';

          ws.getCell('A6').value = 'Unit';
          ws.getCell('A8').value = 'Pressure Target';
          ws.getCell('A9').value = 'Pressure Min';
          ws.getCell('A10').value = 'Pressure HoldTime';
          ws.getCell('A12').value = 'Vacuum Target';
          ws.getCell('A13').value = 'Vacuum Min';
          ws.getCell('A14').value = 'Vacuum HoldTime';

          console.log(ws.getCell('B6').value);
          ws.getCell('B6').value = secModel.Unit;
          ws.getCell('B8').value = secModel.PressureTarget;
          ws.getCell('B9').value = secModel.PressureMin;
          ws.getCell('B10').value = secModel.PressureHoldTime;
          ws.getCell('B12').value = secModel.VacuumTarget;
          ws.getCell('B13').value = secModel.VacuumMin;
          ws.getCell('B14').value = secModel.VacuumHoldTime;

          ws.mergeCells('A1:B1');
          ws.mergeCells('A2:B2');
          ws.mergeCells('B3:C3');
          ws.mergeCells('A5:B5');
        } catch (error) {
          console.log(error);
          ws.getCell('B6').value = secModel.Unit;
          ws.getCell('B8').value = secModel.PressureTarget;
          ws.getCell('B9').value = secModel.PressureMin;
          ws.getCell('B10').value = secModel.PressureHoldTime;
          ws.getCell('B12').value = secModel.VacuumTarget;
          ws.getCell('B13').value = secModel.VacuumMin;
          ws.getCell('B14').value = secModel.VacuumHoldTime;
        }


        workbook.xlsx.writeBuffer().then(function (buffer) {
          saveAs(new Blob([buffer], {
            type: 'application/octet-stream'
          }), secModel.deviceName + nowTime + '.' + 'xlsx');

        });

        secModel.deviceFrame = receivedframe;
        secModel.saveTime = nowTime;
        var content = JSON.stringify(secModel);
        var blob = new Blob([content], { type: "text/plain;charset=utf-8" });
        saveAs(blob, secModel.deviceName + nowTime + '.' + 'txt');

      });
      /*** saveBtn listener below ***/

      // search function
      function searchFunction() {
        var keyWord = document.getElementById("textLabel").value.toUpperCase();

        searchArray = searchByRegExp(keyWord, finalArray);

        var html = '';
        for (var i = 0; i < searchArray.length; i++) {
          html += setDiv(searchArray[i]);
        }
        var deviceDiv = document.getElementById('deviceDiv');

        deviceDiv.innerHTML = html;
      }

      function searchByRegExp(keyWord, list) {
        var listArr = [];
        for (var i = 0; i < list.length; i++) {
          listArr.push(list[i].deviceName);
        }

        var length = list.length;
        var arr = [];
        var reg = new RegExp(keyWord);
        for (var i = 0; i < length; i++) {

          if (listArr[i].match(reg)) {
            arr.push(list[i]);
          }
        }

        return arr;
      }


      function inputFunction(obj) {
        obj.value = obj.value.replace(/[^\d.]/g, "");
        obj.value = obj.value.replace(/^\./g, "");
        obj.value = obj.value.replace(/\.{2,}/g, ".");
        obj.value = obj.value.replace(".", "$#$").replace(/\./g, "").replace("$#$", ".");
      }
      function inputFunction2(obj) {
        // if (!obj.value) {
        //     obj.value=0;
        //   }
        if ($("#unitSelect").val() == "kPa") {
          if (obj.value > 70) {
            obj.value = 70;
          }
        }
        if ($("#unitSelect").val() == "psi") {

          if (obj.value > 8.7) {
            obj.value = 8.7;
          }
        }
        // if (obj.value<0) {
        //    obj.value=0;
        //  }
      }

      function inputFunction3(obj) {

        if ($("#unitSelect").val() == "kPa") {
          if (obj.value < -60) {
            obj.value = -60;
          }
        }
        if ($("#unitSelect").val() == "psi") {

          if (obj.value < -8.7) {
            obj.value = -8.7;
          }
        }
        // if (obj.value>0) {
        //    obj.value=0;
        //  }
      }


      function addLocalDevice(dic) {

        var retNameArr;
        var retPressureTArr;
        var retPressureMArr;
        var retPHoldTimeArr;
        var retVacuumTArr;
        var retVacuumMArr;
        var retVHoldTimeArr;

        retNameArr = ($("#deviceName").val().split(''));
        retPressureTArr = parseInt(Math.round($("#PressureTarget").val() * 100)).toString().split('');
        retPressureMArr = parseInt(Math.round($("#PressureMin").val() * 100)).toString().split('');
        retPHoldTimeArr = parseInt($("#PressureHoldTime").val()).toString().split('');
        retVacuumTArr = parseInt(Math.round(Math.abs($("#VacuumTarget").val()) / 100)).toString().split('');
        retVacuumMArr = parseInt(Math.round(Math.abs($("#VacuumMin").val()) / 100)).toString().split('');
        retVHoldTimeArr = parseInt($("#VacuumHoldTime").val()).toString().split('');


        let retArray = new Uint8Array(80);

        for (var i = 0; i < retArray.length; i++) {
          retArray[i] = 0;
        }

        var num = 0;
        retArray[1] = 129;
        retArray[2] = 47;
        retArray[3] = 1 + 48;

        retArray[4] = 47;
        for (var i = 0; i < retNameArr.length; i++) {
          retArray[i + 5] = retNameArr[i].charCodeAt();
        }
        retArray[35] = 47;  // "/"

        for (var i = 0; i < retPressureTArr.length; i++) {
          retArray[i + 36] = retPressureTArr[i].charCodeAt();

        }
        retArray[39] = 47;
        for (var i = 0; i < retPressureMArr.length; i++) {
          retArray[i + 40] = retPressureMArr[i].charCodeAt();
        }
        retArray[43] = 47;
        for (var i = 0; i < retPHoldTimeArr.length; i++) {
          retArray[i + 44] = retPHoldTimeArr[i].charCodeAt();
        }

        retArray[46] = 47;
        for (var i = 0; i < retVacuumTArr.length; i++) {
          retArray[i + 47] = retVacuumTArr[i].charCodeAt();
        }

        retArray[50] = 47;
        for (var i = 0; i < retVacuumMArr.length; i++) {
          retArray[i + 51] = retVacuumMArr[i].charCodeAt();
        }
        retArray[54] = 47;
        for (var i = 0; i < retVHoldTimeArr.length; i++) {
          retArray[i + 55] = retVHoldTimeArr[i].charCodeAt();
        }
        retArray[57] = 13;


        for (var i = 2; i < 67; i++) {
          num += retArray[i];
        }

        retArray[68] = num & 0xff;
        retArray[67] = (num >> 8) & 0xff;
        sendDataWithArray(retArray);

        alert("Added " + dic.deviceName);
        setTimeout('$("#btnRefresh").click()', 200);

      }

  //changeTab
  function changeTab(el) {
    $(".btn").removeClass("liAct");
    var tabs = ['homePage','helpPage'];
    var name = el.getAttribute("data-name");
    for (var i = 0; i < tabs.length; i++) {
      $("#"+tabs[i]).hide();
    }
    $(el).addClass("liAct");
    $("#"+name).show();
}

    </script>
  </div>
</body>

</html>